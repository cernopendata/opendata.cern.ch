# -*- coding: utf-8 -*-
#
# This file is part of CERN Open Data Portal.
# Copyright (C) 2017 CERN.
#
# CERN Open Data Portal is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of the
# License, or (at your option) any later version.
#
# CERN Open Data Portal is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Invenio; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

"""Implementention of various utility functions."""

from __future__ import absolute_import, print_function

from flask import abort, render_template
from invenio_files_rest.views import ObjectResource
from invenio_records.errors import MissingModelError

from invenio_records_files.utils import record_file_factory

from invenio_previewer.views import blueprint as previewer_blueprint
from invenio_previewer.proxies import current_previewer


def file_download_ui(pid, record, _record_file_factory=None, **kwargs):
    """File download view for a given record.

    Plug this method into your ``RECORDS_UI_ENDPOINTS`` configuration:

    .. code-block:: python

        RECORDS_UI_ENDPOINTS = dict(
            recid=dict(
                # ...
                route='/record/<pid_value/files/<filename>',
                view_imp='invenio_records_files.utils:file_download_ui',
                record_class='invenio_records_files.api:Record',
            )
        )

    :param pid: The :class:`invenio_pidstore.models.PersistentIdentifier`
        instance.
    :param record: The record metadata.
    """
    _record_file_factory = _record_file_factory or record_file_factory
    # Extract file from record.

    fileobj = _record_file_factory(
        pid, record, kwargs.get('filename')
    )

    if not fileobj:
        abort(404)

    obj = fileobj.obj

    # Check permissions
    ObjectResource.check_object_permission(obj)

    # Send file.
    return ObjectResource.send_object(
        obj.bucket, obj,
        # expected_chksum=fileobj.get('checksum'),
        logger_data={
            'bucket_id': obj.bucket_id,
            'pid_type': pid.pid_type,
            'pid_value': pid.pid_value,
        },
        create_dir=False
    )


@previewer_blueprint.app_template_test('previewable_file')
def is_previewable_file(file):
    """Test if a file can be previewed checking its extension."""
    extension = file.get('key', ".").split(".")[-1:][0]
    return extension in current_previewer.previewable_extensions


def record_metadata_view(pid, record, template=None):
    """Record detail view."""
    collection = ""
    if len(record.get('collections', [])) > 0:
        collection = record.get('collections', [])[0]
    return render_template([
        'cernopendata_records_ui/records/record_detail_{}.html'.format(
            collection),
        'cernopendata_records_ui/records/record_detail.html'
    ],
        pid=pid,
        record=record)
